<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Make It Happen Running League</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: #0f172a;
      color: #f9fafb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    header {
      text-align: center;
      padding: 20px 16px 10px;
    }

    .logo {
      display: block;
      margin: 0 auto 12px;
      max-width: 220px;
      height: auto;
      object-fit: contain;
    }

    h1 {
      font-size: 1.7rem;
      margin-bottom: 4px;
    }

    .tagline {
      font-size: 0.9rem;
      color: #94a3b8;
    }

    main {
      flex: 1;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 10px 16px 24px;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 18px 16px;
      margin-bottom: 16px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #cbd5f5;
    }

    input,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e55;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #22c55e;
      color: #020617;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.1s ease,
        background 0.15s ease;
    }

    button:hover {
      background: #16a34a;
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-secondary {
      background: #1f2937;
      color: #e5e7eb;
    }

    .btn-secondary:hover {
      background: #111827;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.6);
    }

    .hidden {
      display: none;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .row > * {
      flex: 1 1 160px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .stat-card {
      padding: 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      border: 1px solid #1f2937;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .stat-unit {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-left: 4px;
    }

    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .leaderboard-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .leaderboard-header h3 {
      margin-bottom: 0;
    }

    .division {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      overflow: hidden;
    }

    .division-header {
      padding: 8px 10px;
      background: linear-gradient(to right, #020617, #111827);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .division-header-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .division-header-meta {
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      background: #020617;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #020617;
    }

    th {
      text-align: left;
      background: #020617;
      color: #9ca3af;
      font-weight: 500;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    tr:nth-child(odd) td {
      background: #020617;
    }

    tr.highlight-current td {
      background: #022c22;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #0f172a;
      border: 1px solid #1e293b;
      color: #9ca3af;
      margin-left: 4px;
    }

    .pill-promo {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .pill-relegation {
      border-color: #ef4444;
      color: #fecaca;
    }

    .footer-text {
      text-align: center;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 6px;
    }

    @media (min-width: 768px) {
      header {
        padding-top: 26px;
      }
      h1 {
        font-size: 2rem;
      }
      .card {
        padding: 20px 18px;
      }
    }
  </style>
</head>

<body>
  <header>
    <!-- Make sure this file is in the same folder as index.html -->
    <img src="hitachi-logo.jpg" alt="Hitachi logo" class="logo" />
    <h1>Make It Happen Running League</h1>
    <p class="tagline">Track your runs. Climb the leagues. Get promoted every month.</p>
  </header>

  <main>
    <!-- ACCOUNT CREATION / LOGIN -->
    <section class="card" id="auth-section">
      <h2>Create your account</h2>
      <p class="note" style="margin-bottom: 8px;">
        When you create an account, your stats and leaderboard position appear immediately. Everything starts at 0.
      </p>

      <form id="signup-form">
        <div class="row">
          <div>
            <label for="signup-name">Name</label>
            <input type="text" id="signup-name" placeholder="Your name" required />
          </div>
          <div>
            <label for="signup-country">Country / City (optional)</label>
            <input type="text" id="signup-country" placeholder="Copenhagen, Denmark" />
          </div>
        </div>
        <button type="submit">Make my account</button>
      </form>

      <hr style="border: none; border-top: 1px solid #1f2937; margin: 14px 0;" />

      <h3>Already have an account on this device?</h3>
      <p class="note">
        Pick your name to log back in. Accounts are saved in this browser only using localStorage.
      </p>
      <div class="row" style="align-items: flex-end; margin-top: 6px;">
        <div>
          <label for="existing-user-select">Select runner</label>
          <select id="existing-user-select"></select>
        </div>
        <div style="display: flex; gap: 8px;">
          <button type="button" class="btn-secondary" id="login-btn">Log in</button>
          <button type="button" class="btn-secondary" id="delete-user-btn">Delete runner</button>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section class="card hidden" id="dashboard-section">
      <h2>Hello, <span id="current-user-name"></span></h2>
      <p class="note">
        Add your runs or walks below. Your stats update instantly.
      </p>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total distance</div>
          <div>
            <span class="stat-value" id="stat-distance">0</span>
            <span class="stat-unit">km</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Time spent</div>
          <div>
            <span class="stat-value" id="stat-time">0</span>
            <span class="stat-unit">min</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average speed</div>
          <div>
            <span class="stat-value" id="stat-speed">0</span>
            <span class="stat-unit">km/h</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Current division</div>
          <div>
            <span class="stat-value" id="stat-division">1</span>
            <span class="stat-unit">lower is better</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ADD ACTIVITY -->
    <section class="card hidden" id="activity-section">
      <h2>Add a run / walk</h2>
      <form id="activity-form">
        <div class="row">
          <div>
            <label for="distance-input">Distance (km)</label>
            <input
              type="number"
              id="distance-input"
              min="0"
              step="0.01"
              placeholder="5"
              required
            />
          </div>
          <div>
            <label for="time-input">Time (minutes)</label>
            <input
              type="number"
              id="time-input"
              min="0"
              step="1"
              placeholder="30"
              required
            />
          </div>
        </div>
        <button type="submit">Save activity</button>
      </form>
      <p class="note">
        Your total distance, total time, and average speed update instantly.
        These three stats are used for promotions and relegations.
      </p>
    </section>

    <!-- LEADERBOARDS -->
    <section class="card hidden" id="leaderboard-section">
      <div class="leaderboard-header">
        <div>
          <h2>Leaderboards & leagues</h2>
          <p class="note">
            Promotions and relegations happen once a month based on:
            Distance, Speed and Time spent.
          </p>
        </div>
        <div style="text-align: right;">
          <button type="button" id="run-promotions-btn">
            Run monthly promotions now
          </button>
          <p class="note">
            For testing; acts like the end of the month.
          </p>
        </div>
      </div>
      <div id="divisions-container"></div>
      <p class="footer-text">
        Rules: 8+ people in a division = 1 up / 1 down.
        16+ = 2 up / 2 down. 32+ = 3 up / 3 down.
      </p>
    </section>
  </main>

  <script>
    // --- Simple data model in localStorage -----------------------------------

    const STORAGE_KEY_USERS = "mih-users-v1";
    const STORAGE_KEY_CURRENT = "mih-current-user-id";

    function loadUsers() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_USERS);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error("Failed to load users", e);
        return [];
      }
    }

    function saveUsers(users) {
      localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
    }

    function loadCurrentUserId() {
      return localStorage.getItem(STORAGE_KEY_CURRENT);
    }

    function saveCurrentUserId(id) {
      if (id === null) {
        localStorage.removeItem(STORAGE_KEY_CURRENT);
      } else {
        localStorage.setItem(STORAGE_KEY_CURRENT, String(id));
      }
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    // --- League logic --------------------------------------------------------

    function rankUsers(users) {
      // Sort by:
      // 1) distance desc
      // 2) avgSpeed desc
      // 3) totalMinutes desc
      return [...users].sort((a, b) => {
        if (b.stats.distance !== a.stats.distance) {
          return b.stats.distance - a.stats.distance;
        }
        if (b.stats.avgSpeed !== a.stats.avgSpeed) {
          return b.stats.avgSpeed - a.stats.avgSpeed;
        }
        return b.stats.totalMinutes - a.stats.totalMinutes;
      });
    }

    function getPromotionCount(size) {
      if (size >= 32) return 3;
      if (size >= 16) return 2;
      if (size >= 8) return 1;
      return 0;
    }

    function reassignDivisionsByRank(users) {
      // Reassign divisions based on overall rank:
      // top 10 -> division 1, next 10 -> division 2, etc.
      const ranked = rankUsers(users);
      ranked.forEach((u, index) => {
        const rank = index + 1;
        u.division = Math.ceil(rank / 10) || 1;
      });
      return ranked;
    }

    function runMonthlyPromotions(users) {
      // Group by division
      const byDivision = {};
      users.forEach((u) => {
        if (!byDivision[u.division]) byDivision[u.division] = [];
        byDivision[u.division].push(u);
      });

      const divisions = Object.keys(byDivision)
        .map((d) => parseInt(d, 10))
        .sort((a, b) => a - b);

      const moves = new Map(); // userId -> newDivision

      divisions.forEach((div) => {
        const group = byDivision[div];
        const size = group.length;
        const k = getPromotionCount(size);
        if (k === 0) return;

        // Sort group by rank (best first)
        const sorted = rankUsers(group);
        const top = sorted.slice(0, k);
        const bottom = sorted.slice(-k);

        // Promotions
        top.forEach((user) => {
          const newDiv = Math.max(1, user.division - 1);
          moves.set(user.id, newDiv);
        });

        // Relegations
        bottom.forEach((user) => {
          const newDiv = user.division + 1;
          moves.set(user.id, newDiv);
        });
      });

      // Apply moves
      users.forEach((u) => {
        if (moves.has(u.id)) {
          u.division = moves.get(u.id);
        }
      });

      return users;
    }

    // --- UI helpers ----------------------------------------------------------

    const authSection = document.getElementById("auth-section");
    const dashboardSection = document.getElementById("dashboard-section");
    const activitySection = document.getElementById("activity-section");
    const leaderboardSection = document.getElementById("leaderboard-section");

    const currentUserNameEl = document.getElementById("current-user-name");
    const statDistanceEl = document.getElementById("stat-distance");
    const statTimeEl = document.getElementById("stat-time");
    const statSpeedEl = document.getElementById("stat-speed");
    const statDivisionEl = document.getElementById("stat-division");
    const divisionsContainer = document.getElementById("divisions-container");

    const signupForm = document.getElementById("signup-form");
    const signupNameInput = document.getElementById("signup-name");
    const signupCountryInput = document.getElementById("signup-country");
    const existingUserSelect = document.getElementById("existing-user-select");
    const loginBtn = document.getElementById("login-btn");
    const deleteUserBtn = document.getElementById("delete-user-btn");

    const activityForm = document.getElementById("activity-form");
    const distanceInput = document.getElementById("distance-input");
    const timeInput = document.getElementById("time-input");
    const runPromotionsBtn = document.getElementById("run-promotions-btn");

    let users = loadUsers();
    let currentUserId = loadCurrentUserId();

    function findUserById(id) {
      return users.find((u) => u.id === id);
    }

    function updateExistingUserSelect() {
      existingUserSelect.innerHTML = "";
      if (users.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "No runners yet";
        existingUserSelect.appendChild(option);
        existingUserSelect.disabled = true;
        loginBtn.disabled = true;
        deleteUserBtn.disabled = true;
        return;
      }

      existingUserSelect.disabled = false;
      loginBtn.disabled = false;
      deleteUserBtn.disabled = false;

      users.forEach((u) => {
        const option = document.createElement("option");
        option.value = u.id;
        const location =
          u.country && u.country.trim().length > 0 ? ` (${u.country})` : "";
        option.textContent = `${u.name}${location}`;
        existingUserSelect.appendChild(option);
      });

      if (currentUserId) {
        existingUserSelect.value = currentUserId;
      }
    }

    function showDashboard(show) {
      if (show) {
        dashboardSection.classList.remove("hidden");
        activitySection.classList.remove("hidden");
        leaderboardSection.classList.remove("hidden");
      } else {
        dashboardSection.classList.add("hidden");
        activitySection.classList.add("hidden");
        leaderboardSection.classList.add("hidden");
      }
    }

    function updateStatsUI() {
      if (!currentUserId) return;
      const user = findUserById(currentUserId);
      if (!user) return;

      currentUserNameEl.textContent = user.name;
      statDistanceEl.textContent = user.stats.distance.toFixed(2);
      statTimeEl.textContent = user.stats.totalMinutes.toFixed(0);
      statSpeedEl.textContent = user.stats.avgSpeed.toFixed(2);
      statDivisionEl.textContent = user.division;
    }

    function renderLeaderboards() {
      divisionsContainer.innerHTML = "";

      if (users.length === 0) {
        const p = document.createElement("p");
        p.className = "note";
        p.textContent =
          "No runners yet. Create an account to be the very first one.";
        divisionsContainer.appendChild(p);
        return;
      }

      // Ensure divisions make sense based on ranking
      users = reassignDivisionsByRank(users);
      saveUsers(users);

      // Group by division
      const byDivision = {};
      users.forEach((u) => {
        if (!byDivision[u.division]) byDivision[u.division] = [];
        byDivision[u.division].push(u);
      });

      const divisions = Object.keys(byDivision)
        .map((d) => parseInt(d, 10))
        .sort((a, b) => a - b);

      divisions.forEach((div) => {
        const wrapper = document.createElement("div");
        wrapper.className = "division";

        const header = document.createElement("div");
        header.className = "division-header";

        const title = document.createElement("div");
          title.className = "division-header-title";
          title.textContent = `Division ${div}`;

        const size = byDivision[div].length;
        const k = getPromotionCount(size);
        const meta = document.createElement("div");
        meta.className = "division-header-meta";

        const promoSpan = document.createElement("span");
        promoSpan.className = "pill pill-promo";
        promoSpan.textContent = `Promoted: ${k}`;

        const relSpan = document.createElement("span");
        relSpan.className = "pill pill-relegation";
        relSpan.textContent = `Relegated: ${k}`;

        meta.textContent = `${size} runners`;
        meta.appendChild(document.createElement("br"));
        meta.appendChild(promoSpan);
        meta.appendChild(relSpan);

        header.appendChild(title);
        header.appendChild(meta);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Distance (km)</th>
            <th>Time (min)</th>
            <th>Speed (km/h)</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const ranked = rankUsers(byDivision[div]);
        ranked.forEach((u, index) => {
          const tr = document.createElement("tr");

          if (u.id === currentUserId) {
            tr.classList.add("highlight-current");
          }

          const tdRank = document.createElement("td");
          tdRank.textContent = index + 1;

          const tdName = document.createElement("td");
          tdName.textContent = u.name;

          const tdDist = document.createElement("td");
          tdDist.textContent = u.stats.distance.toFixed(2);

          const tdTime = document.createElement("td");
          tdTime.textContent = u.stats.totalMinutes.toFixed(0);

          const tdSpeed = document.createElement("td");
          tdSpeed.textContent = u.stats.avgSpeed.toFixed(2);

          tr.appendChild(tdRank);
          tr.appendChild(tdName);
          tr.appendChild(tdDist);
          tr.appendChild(tdTime);
          tr.appendChild(tdSpeed);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        wrapper.appendChild(header);
        wrapper.appendChild(table);
        divisionsContainer.appendChild(wrapper);
      });
    }

    // --- Event handlers ------------------------------------------------------

    // Create account
    signupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = signupNameInput.value.trim();
      const country = signupCountryInput.value.trim();

      if (!name) return;

      const id = generateId();

      const newUser = {
        id,
        name,
        country,
        division: 1,
        stats: {
          distance: 0,
          totalMinutes: 0,
          avgSpeed: 0,
        },
      };

      users.push(newUser);
      saveUsers(users);
      currentUserId = id;
      saveCurrentUserId(id);

      signupForm.reset();
      updateExistingUserSelect();
      showDashboard(true);
      updateStatsUI();
      renderLeaderboards();
    });

    // Log in existing user
    loginBtn.addEventListener("click", () => {
      const selectedId = existingUserSelect.value;
      if (!selectedId) return;
      currentUserId = selectedId;
      saveCurrentUserId(selectedId);
      showDashboard(true);
      updateStatsUI();
      renderLeaderboards();
    });

    // Delete user
    deleteUserBtn.addEventListener("click", () => {
      const selectedId = existingUserSelect.value;
      if (!selectedId) return;
      const user = findUserById(selectedId);
      if (!user) return;

      const ok = confirm(
        `Delete runner "${user.name}" from this device? This cannot be undone.`
      );
      if (!ok) return;

      users = users.filter((u) => u.id !== selectedId);
      saveUsers(users);

      if (currentUserId === selectedId) {
        currentUserId = null;
        saveCurrentUserId(null);
        showDashboard(false);
      }

      updateExistingUserSelect();
      renderLeaderboards();
    });

    // Add activity
    activityForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!currentUserId) return;
      const dist = parseFloat(distanceInput.value);
      const mins = parseFloat(timeInput.value);

      if (!isFinite(dist) || dist <= 0) return;
      if (!isFinite(mins) || mins <= 0) return;

      const user = findUserById(currentUserId);
      if (!user) return;

      user.stats.distance += dist;
      user.stats.totalMinutes += mins;
      const hours = user.stats.totalMinutes / 60;
      user.stats.avgSpeed = hours > 0 ? user.stats.distance / hours : 0;

      saveUsers(users);

      distanceInput.value = "";
      timeInput.value = "";

      updateStatsUI();
      renderLeaderboards();
    });

    // Run monthly promotions
    runPromotionsBtn.addEventListener("click", () => {
      if (users.length === 0) return;
      users = runMonthlyPromotions(users);
      saveUsers(users);
      updateStatsUI();
      renderLeaderboards();
      alert("Monthly promotions and relegations have been applied.");
    });

    // --- Initial load --------------------------------------------------------

    updateExistingUserSelect();

    if (currentUserId && findUserById(currentUserId)) {
      showDashboard(true);
      updateStatsUI();
    } else {
      showDashboard(false);
    }

    renderLeaderboards();
  </script>
</body>
</html>
