<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Make It Happen â€“ Hitachi Vantara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="hitachi-logo.jpg">
  <link rel="icon" type="image/jpeg" sizes="192x192" href="hitachi-logo.jpg">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: Inter, sans-serif;
      background: #f7f7f7;
      color: #222;
    }

    header {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header nav button {
      background: none;
      border: none;
      padding: 8px 12px;
      font-size: 15px;
      cursor: pointer;
    }

    header nav button.active {
      font-weight: bold;
      color: #e60028; /* Hitachi red */
    }

    .scene {
      display: none;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    .scene.active {
      display: block;
    }

    h1, h2 {
      color: #e60028; /* Hitachi red */
    }

    .btn {
      background: #e60028;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 8px 0;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 14px;
    }

    .danger {
      background: #b00000;
    }

    .input {
      width: 100%;
      padding: 10px;
      margin: 6px 0 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .badge-league {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: white;
    }
    .amateurs { background: #6c757d; }
    .intermediates { background: #007bff; }
    .pros { background: #28a745; }
    .legends { background: #e60028; }
  </style>
</head>

<body>

<header>
  <nav>
    <button onclick="showScene('welcome')" data-i18n="nav.welcome"></button>
    <button onclick="showScene('leaderboard')" data-i18n="nav.leaderboard"></button>
    <button onclick="showScene('stats')" data-i18n="nav.stats"></button>
    <button onclick="showScene('rules')" data-i18n="nav.rules"></button>
    <button onclick="showScene('about')" data-i18n="nav.about"></button>
    <button onclick="showScene('login')" data-i18n="nav.login"></button>
  </nav>

  <div style="display:flex; gap:8px; align-items:center;">
    <select id="lang-select">
      <option value="en">English</option>
      <option value="da">Dansk</option>
      <option value="ja">æ—¥æœ¬èªž</option>
    </select>

    <div id="user-controls"></div>
  </div>
</header>

<!-- WELCOME SCENE -->
<section id="scene-welcome" class="scene active">
  <h1 data-i18n="welcome.title"></h1>
  <p data-i18n="welcome.subtitle"></p>
  <button class="btn" onclick="showScene('login')" data-i18n="welcome.cta"></button>
</section>

<!-- LOGIN SCENE -->
<section id="scene-login" class="scene">
  <h1 data-i18n="login.title"></h1>
  <p data-i18n="login.description"></p>

  <form id="login-form">
    <label data-i18n="login.name"></label>
    <input id="login-name" class="input" type="text">

    <label data-i18n="login.password"></label>
    <input id="login-password" class="input" type="password">

    <label data-i18n="login.code"></label>
    <input id="login-code" class="input" maxlength="20">

    <button class="btn" data-i18n="login.submit"></button>
  </form>

  <p data-i18n="login.note"></p>
</section>

<!-- LEADERBOARD SCENE -->
<section id="scene-leaderboard" class="scene">
  <h1 data-i18n="leaderboard.title"></h1>

  <label data-i18n="leaderboard.filter"></label>
  <select id="league-filter">
    <option value="all" data-i18n="leaderboard.all"></option>
    <option value="amateurs" data-i18n="league.amateurs"></option>
    <option value="intermediates" data-i18n="league.intermediates"></option>
    <option value="pros" data-i18n="league.pros"></option>
    <option value="legends" data-i18n="league.legends"></option>
  </select>

  <table>
    <thead>
      <tr>
        <th data-i18n="lb.rank"></th>
        <th data-i18n="lb.name"></th>
        <th data-i18n="lb.league"></th>
        <th data-i18n="lb.distance"></th>
        <th data-i18n="lb.time"></th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <p id="no-entries" data-i18n="leaderboard.none"></p>
</section>

<!-- STATS SCENE -->
<section id="scene-stats" class="scene">
  <h1 data-i18n="stats.title"></h1>

  <table>
    <thead>
      <tr>
        <th data-i18n="lb.name"></th>
        <th data-i18n="lb.league"></th>
        <th data-i18n="stats.runs"></th>
        <th data-i18n="stats.totaldistance"></th>
        <th data-i18n="stats.totaltime"></th>
        <th data-i18n="stats.avgdistance"></th>
        <th data-i18n="stats.bestdistance"></th>
        <th data-i18n="stats.improvement"></th>
      </tr>
    </thead>
    <tbody id="stats-body"></tbody>
  </table>

  <p id="no-stats" data-i18n="stats.none"></p>

  <div style="margin-top:20px;">
    <button class="btn" onclick="applyPromotions()" data-i18n="stats.promotions"></button>
    <button class="btn" onclick="placeNewJoiners()" data-i18n="stats.placejoiners"></button>
  </div>
</section>

<!-- RULES SCENE -->
<section id="scene-rules" class="scene">
  <h1 data-i18n="rules.title"></h1>

  <h2 data-i18n="rules.joiningtitle"></h2>
  <p data-i18n="rules.joiningtext"></p>

  <h2 data-i18n="rules.leaguetitle"></h2>
  <p data-i18n="rules.leaguetext"></p>

  <h2 data-i18n="rules.promotiontitle"></h2>
  <p data-i18n="rules.promotiontext"></p>

  <h2 data-i18n="rules.prizetitle"></h2>
  <p data-i18n="rules.prizetext"></p>
</section>

<!-- ABOUT SCENE -->
<section id="scene-about" class="scene">
  <h1 data-i18n="about.title"></h1>
  <p data-i18n="about.text1"></p>
  <p data-i18n="about.text2"></p>
  <p data-i18n="about.text3"></p>
</section>

<!-- ENTRY FORM + MY ACTIVITIES -->
<section id="scene-entry" class="scene">
  <h1 data-i18n="entry.title"></h1>

  <form id="entry-form">
    <label data-i18n="entry.distance"></label>
    <input id="distance" type="number" step="0.01" class="input">

    <label data-i18n="entry.time"></label>
    <input id="time" type="number" step="0.01" class="input">

    <button class="btn" data-i18n="entry.submit"></button>
  </form>

  <h2 data-i18n="entry.my"></h2>
  <table>
    <thead>
      <tr>
        <th data-i18n="entry.date"></th>
        <th data-i18n="entry.distance"></th>
        <th data-i18n="entry.time"></th>
        <th data-i18n="entry.actions"></th>
      </tr>
    </thead>
    <tbody id="my-activities-body"></tbody>
  </table>

  <p id="no-my-activities" data-i18n="entry.none"></p>
</section>

<!-- PROFILE SCENE -->
<section id="profile-card" class="scene" style="display:none;">
  <h1 id="profile-title"></h1>
  <p id="profile-summary"></p>

  <table>
    <tr><th data-i18n="profile.runs"></th><td id="profile-runs"></td></tr>
    <tr><th data-i18n="profile.totaldistance"></th><td id="profile-total-distance"></td></tr>
    <tr><th data-i18n="profile.totaltime"></th><td id="profile-total-time"></td></tr>
    <tr><th data-i18n="profile.avgdistance"></th><td id="profile-avg-distance"></td></tr>
    <tr><th data-i18n="profile.avgpace"></th><td id="profile-avg-pace"></td></tr>
    <tr><th data-i18n="profile.longest"></th><td id="profile-longest"></td></tr>
    <tr><th data-i18n="profile.best100m"></th><td id="profile-100m"></td></tr>
    <tr><th data-i18n="profile.best5k"></th><td id="profile-5k"></td></tr>
  </table>
</section>

<!-- PART 2 SCRIPT WILL BE INSERTED BELOW -->
<!-- â†“â†“â†“ ASK ME WHEN READY FOR PART 2 â†“â†“â†“ -->
<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
  // ==========================
  //  CONFIG
  // ==========================

  // TODO: replace this with YOUR Firebase config from the Firebase console
  const firebaseConfig = {

  apiKey: "AIzaSyAkbH3mJkeheF3L7EaqN1kMgbFd_LJCIXo",

  authDomain: "hitachi-vantara-make-it-happen.firebaseapp.com",

  projectId: "hitachi-vantara-make-it-happen",

  storageBucket: "hitachi-vantara-make-it-happen.firebasestorage.app",

  messagingSenderId: "749690169824",

  appId: "1:749690169824:web:21d6b8d2a5862847e4e385",

  measurementId: "G-7WZ03E68MF"

};
 
  const HITACHI_CODE = "27HG0QIBD2";
  const LS_CODE_OK_KEY = "mih_hitachi_code_ok";
  const LS_CURRENT_USER_KEY = "mih_current_user_id";
  const LS_LANG_KEY = "mih_lang";

  const LEAGUES = ["amateurs", "intermediates", "pros", "legends"];
  const MIN_RUNS_FOR_PLACEMENT = 3;

  let db = null;
  let users = [];
  let entries = [];
  let currentUser = null;
  let currentLang = "en";

  // ==========================
  //  TRANSLATIONS
  // ==========================

  const translations = {
    en: {
      // nav
      "nav.welcome": "Welcome",
      "nav.leaderboard": "Leaderboard",
      "nav.stats": "Stats",
      "nav.rules": "Rules & prizes",
      "nav.about": "About",
      "nav.login": "Login",

      // welcome
      "welcome.title": "Move more. Compete together.",
      "welcome.subtitle": "Make It Happen is a health challenge for Hitachi Vantara. Walk, run or cycle, log your distance and climb the leagues.",
      "welcome.cta": "Log in or create an account",

      // login
      "login.title": "Log in to Make It Happen",
      "login.description": "Create a simple account so the site knows who you are and only you can manage your activities.",
      "login.name": "Name",
      "login.password": "Password",
      "login.code": "Hitachi Vantara join code",
      "login.submit": "Log in / Create account",
      "login.note": "Only Hitachi Vantara members can join. Your account is stored in the shared database, not just on your device. If you do not use your account for a long time it may be cleaned up.",

      // leagues
      "league.amateurs": "Amateurs",
      "league.intermediates": "Intermediates",
      "league.pros": "Pros",
      "league.legends": "Legends",
      "league.pending": "Pending",

      // leaderboard
      "leaderboard.title": "Leaderboard",
      "leaderboard.filter": "Filter by league:",
      "leaderboard.all": "All leagues",
      "leaderboard.none": "No activities yet. Be the first to log something.",
      "lb.rank": "#",
      "lb.name": "Name",
      "lb.league": "League",
      "lb.distance": "Total distance (km)",
      "lb.time": "Total time (min)",

      // stats
      "stats.title": "Player stats and league moves",
      "stats.runs": "Runs",
      "stats.totaldistance": "Total distance (km)",
      "stats.totaltime": "Total time (min)",
      "stats.avgdistance": "Average distance (km)",
      "stats.bestdistance": "Longest distance (km)",
      "stats.improvement": "Improvement",
      "stats.none": "Stats will appear once people start logging activities.",
      "stats.promotions": "Apply promotions / relegations for this month",
      "stats.placejoiners": "Place new joiners into leagues",

      // rules
      "rules.title": "Rules, leagues and prizes",
      "rules.joiningtitle": "Joining and signing up",
      "rules.joiningtext":
        "Only Hitachi Vantara members can join, using the access code. You can sign up any time. When you create an account you start as â€œPendingâ€. You can log activities straight away. At the start of the next month, the organiser presses the button to place all pending players into the leagues based on their distance, time and speed.",
      "rules.leaguetitle": "Leagues and balance",
      "rules.leaguetext":
        "There are four leagues: Amateurs, Intermediates, Pros and Legends. The system tries to keep league sizes balanced. When placing new joiners it avoids making one league much larger than the others, so that the difference between the biggest and smallest league stays small.",
      "rules.promotiontitle": "Promotions and relegations",
      "rules.promotiontext":
        "Each month you can apply promotions and relegations from the Stats page. The number of players moved depends on how many people are active: with 8+ players there is 1 promotion and 1 relegation, with 16+ there are 2 of each, and with 32+ there are 3 of each. Rankings are based on total distance first, then total time, then average speed.",
      "rules.prizetitle": "Prizes",
      "rules.prizetext":
        "Local teams can decide the exact prizes. A simple version is: a small prize for the monthly winner and a bigger prize at the end of the year for the player with the strongest overall performance.",

      // about
      "about.title": "About Make It Happen",
      "about.text1":
        "Make It Happen is a simple, fair health challenge for Hitachi Vantara. The goal is not to create elite athletes, but to give everyone a clear, friendly way to move more and see progress over time.",
      "about.text2":
        "You can walk, run or cycle and log your distance and time. The system looks at both how far you go and how long you spend moving. That means slower but very dedicated people still get rewarded, not only the fastest runners.",
      "about.text3":
        "New players sign up first, then officially join a league at the start of the next month. The site compares their first month to everyone else, then places them into the league that fits them best while keeping league sizes balanced.",

      // entry
      "entry.title": "Log a new activity",
      "entry.distance": "Distance (km)",
      "entry.time": "Time (minutes)",
      "entry.submit": "Save my activity",
      "entry.my": "My activities",
      "entry.date": "Date",
      "entry.actions": "Actions",
      "entry.none": "You have no activities yet for this account.",

      // profile
      "profile.runs": "Runs",
      "profile.totaldistance": "Total distance",
      "profile.totaltime": "Total time",
      "profile.avgdistance": "Average distance",
      "profile.avgpace": "Average pace",
      "profile.longest": "Longest activity",
      "profile.best100m": "Fastest ~100 m",
      "profile.best5k": "Fastest ~5 km",

      // user header
      "user.notLoggedIn": "Not logged in",
      "user.loginButton": "Login",
      "user.loggedInAs": "Logged in as {name}",
      "user.leagueLabel": "League: {league}",
      "user.addActivity": "Add activity",
      "user.logout": "Log out",
      "user.deleteAccount": "Delete account",

      // alerts (main ones)
      "alert.loginMissing": "Please enter both name and password.",
      "alert.codeWrong": "The Hitachi code is wrong.",
      "alert.passwordWrong": "Wrong password for this name.",
      "alert.firebase": "Firebase is not configured yet. Please add your Firebase config in the script.",
      "alert.mustLogin": "Please log in before adding activities.",
      "alert.activityInvalid": "Please fill in distance and time correctly with positive values.",
      "alert.noPlayers": "No players yet.",
      "alert.notEnoughPlayers": "You need at least 8 players for promotions and relegations.",
      "alert.promotionsDone": "Promotions and relegations applied: {up} up, {down} down.",
      "alert.noActivitiesToPlace": "No activities yet, nothing to place.",
      "alert.noPending": "No pending joiners ready to place. New sign-ups will join at the start of the next month.",
      "alert.placeSummary": "Placed {placed} new joiner(s) into leagues. {skipped}",
      "alert.placeSkipped": "{count} left pending (not enough data yet or for balance).",
      "alert.deleteActivityConfirm": "Delete this activity?",
      "alert.deleteAccountConfirm": "This will delete your account and all your activities. Are you sure?"
    },

    da: {
      "nav.welcome": "Velkomst",
      "nav.leaderboard": "Rangliste",
      "nav.stats": "Statistik",
      "nav.rules": "Regler og prÃ¦mier",
      "nav.about": "Om projektet",
      "nav.login": "Log ind",

      "welcome.title": "BevÃ¦g dig mere. KonkurrÃ©r sammen.",
      "welcome.subtitle": "Make It Happen er en sundhedsudfordring for Hitachi Vantara. GÃ¥, lÃ¸b eller cykl, registrÃ©r din distance og ryk op gennem ligaerne.",
      "welcome.cta": "Log ind eller opret konto",

      "login.title": "Log ind pÃ¥ Make It Happen",
      "login.description": "Lav en enkel konto, sÃ¥ siden ved, hvem du er, og kun du kan styre dine aktiviteter.",
      "login.name": "Navn",
      "login.password": "Adgangskode",
      "login.code": "Hitachi Vantara adgangskode",
      "login.submit": "Log ind / Opret konto",
      "login.note": "Kun medarbejdere i Hitachi Vantara kan deltage, med adgangskoden. Din konto ligger i en delt database, ikke kun pÃ¥ din egen enhed. Hvis du ikke bruger din konto i lang tid, kan den blive ryddet op.",

      "league.amateurs": "AmatÃ¸rer",
      "league.intermediates": "Ã˜vede",
      "league.pros": "Prof",
      "league.legends": "Legender",
      "league.pending": "Afventer",

      "leaderboard.title": "Rangliste",
      "leaderboard.filter": "FiltrÃ©r efter liga:",
      "leaderboard.all": "Alle ligaer",
      "leaderboard.none": "Ingen aktiviteter endnu. VÃ¦r den fÃ¸rste til at logge noget.",
      "lb.rank": "#",
      "lb.name": "Navn",
      "lb.league": "Liga",
      "lb.distance": "Samlet distance (km)",
      "lb.time": "Samlet tid (min)",

      "stats.title": "Spillerstatistik og ligaflytninger",
      "stats.runs": "Ture",
      "stats.totaldistance": "Samlet distance (km)",
      "stats.totaltime": "Samlet tid (min)",
      "stats.avgdistance": "Gennemsnitlig distance (km)",
      "stats.bestdistance": "LÃ¦ngste tur (km)",
      "stats.improvement": "Forbedring",
      "stats.none": "Statistik vises, nÃ¥r deltagerne begynder at logge aktiviteter.",
      "stats.promotions": "UdfÃ¸r oprykning og nedrykning for denne mÃ¥ned",
      "stats.placejoiners": "PlacÃ©r nye deltagere i ligaer",

      "rules.title": "Regler, ligaer og prÃ¦mier",
      "rules.joiningtitle": "Tilmelding og opstart",
      "rules.joiningtext":
        "Kun medarbejdere i Hitachi Vantara kan deltage, ved hjÃ¦lp af adgangskoden. Du kan tilmelde dig nÃ¥r som helst. NÃ¥r du opretter en konto, starter du som â€œAfventerâ€. Du kan logge aktiviteter med det samme. Ved starten af nÃ¦ste mÃ¥ned trykker tovholderen pÃ¥ knappen, som placerer alle afventende spillere i ligaerne ud fra deres distance, tid og hastighed.",
      "rules.leaguetitle": "Ligaer og balance",
      "rules.leaguetext":
        "Der er fire ligaer: AmatÃ¸rer, Ã˜vede, Prof og Legender. Systemet forsÃ¸ger at holde ligastÃ¸rrelserne nogenlunde i balance. NÃ¥r nye deltagere placeres, undgÃ¥r det at gÃ¸re Ã©n liga meget stÃ¸rre end de andre, sÃ¥ forskellen mellem den stÃ¸rste og mindste liga forbliver lille.",
      "rules.promotiontitle": "Oprykning og nedrykning",
      "rules.promotiontext":
        "Hver mÃ¥ned kan du udfÃ¸re oprykning og nedrykning fra Statistik-siden. Antallet af spillere der flyttes, afhÃ¦nger af hvor mange der er aktive: ved 8+ spillere er der 1 oprykning og 1 nedrykning, ved 16+ er der 2 af hver, og ved 32+ er der 3 af hver. Ranglisten bygger fÃ¸rst pÃ¥ samlet distance, derefter samlet tid, og til sidst gennemsnitlig hastighed.",
      "rules.prizetitle": "PrÃ¦mier",
      "rules.prizetext":
        "De lokale teams beslutter prÃ¦mierne. En enkel model er: en lille prÃ¦mie til den mÃ¥nedlige vinder og en stÃ¸rre prÃ¦mie ved Ã¥rets slutning til den spiller, der samlet set har klaret sig bedst.",

      "about.title": "Om Make It Happen",
      "about.text1":
        "Make It Happen er en enkel, fair sundhedsudfordring for Hitachi Vantara. MÃ¥let er ikke at skabe elitesportsfolk, men at give alle en klar og venlig mÃ¥de at bevÃ¦ge sig mere og se deres udvikling over tid.",
      "about.text2":
        "Du kan gÃ¥, lÃ¸be eller cykle og registrere din distance og tid. Systemet kigger bÃ¥de pÃ¥ hvor langt du kommer, og hvor lÃ¦nge du er i bevÃ¦gelse. Det betyder, at langsommere men meget dedikerede deltagere ogsÃ¥ bliver belÃ¸nnet, ikke kun de hurtigste lÃ¸bere.",
      "about.text3":
        "Nye spillere tilmelder sig fÃ¸rst og trÃ¦der officielt ind i en liga ved starten af nÃ¦ste mÃ¥ned. Siden sammenligner deres fÃ¸rste mÃ¥ned med resten af feltet og placerer dem i den liga, der passer bedst, samtidig med at ligastÃ¸rrelserne holdes i balance.",

      "entry.title": "RegistrÃ©r en ny aktivitet",
      "entry.distance": "Distance (km)",
      "entry.time": "Tid (minutter)",
      "entry.submit": "Gem min aktivitet",
      "entry.my": "Mine aktiviteter",
      "entry.date": "Dato",
      "entry.actions": "Handlinger",
      "entry.none": "Du har ingen aktiviteter endnu pÃ¥ denne konto.",

      "profile.runs": "Ture",
      "profile.totaldistance": "Samlet distance",
      "profile.totaltime": "Samlet tid",
      "profile.avgdistance": "Gennemsnitlig distance",
      "profile.avgpace": "Gennemsnitstempo",
      "profile.longest": "LÃ¦ngste aktivitet",
      "profile.best100m": "Hurtigste ~100 m",
      "profile.best5k": "Hurtigste ~5 km",

      "user.notLoggedIn": "Ikke logget ind",
      "user.loginButton": "Log ind",
      "user.loggedInAs": "Logget ind som {name}",
      "user.leagueLabel": "Liga: {league}",
      "user.addActivity": "TilfÃ¸j aktivitet",
      "user.logout": "Log ud",
      "user.deleteAccount": "Slet konto",

      "alert.loginMissing": "Indtast bÃ¥de navn og adgangskode.",
      "alert.codeWrong": "Hitachi-adgangskoden er forkert.",
      "alert.passwordWrong": "Forkert adgangskode til dette navn.",
      "alert.firebase": "Firebase er ikke sat korrekt op. IndsÃ¦t din Firebase-konfiguration i scriptet.",
      "alert.mustLogin": "Log ind, fÃ¸r du tilfÃ¸jer aktiviteter.",
      "alert.activityInvalid": "Udfyld distance og tid korrekt med positive vÃ¦rdier.",
      "alert.noPlayers": "Ingen spillere endnu.",
      "alert.notEnoughPlayers": "Du skal bruge mindst 8 spillere til oprykning og nedrykning.",
      "alert.promotionsDone": "Oprykning og nedrykning udfÃ¸rt: {up} op, {down} ned.",
      "alert.noActivitiesToPlace": "Ingen aktiviteter endnu, intet at placere.",
      "alert.noPending": "Ingen afventende deltagere klar til placering. Nye tilmeldinger kommer med ved starten af nÃ¦ste mÃ¥ned.",
      "alert.placeSummary": "Placerede {placed} ny(e) deltager(e) i ligaer. {skipped}",
      "alert.placeSkipped": "{count} blev efterladt som Afventer (mangler data eller for balance).",
      "alert.deleteActivityConfirm": "Slet denne aktivitet?",
      "alert.deleteAccountConfirm": "Dette sletter din konto og alle dine aktiviteter. Er du sikker?"
    },

    ja: {
      "nav.welcome": "ã‚ˆã†ã“ã",
      "nav.leaderboard": "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
      "nav.stats": "çµ±è¨ˆ",
      "nav.rules": "ãƒ«ãƒ¼ãƒ«ã¨è³žå“",
      "nav.about": "ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦",
      "nav.login": "ãƒ­ã‚°ã‚¤ãƒ³",

      "welcome.title": "ã‚‚ã£ã¨å‹•ãã€‚ã¿ã‚“ãªã§ç«¶ã†ã€‚",
      "welcome.subtitle": "ã€ŒMake It Happenã€ã¯ Hitachi Vantara ã®ãŸã‚ã®ãƒ˜ãƒ«ã‚¹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã™ã€‚æ­©ããƒ»èµ°ã‚‹ãƒ»è‡ªè»¢è»Šã§ç§»å‹•ã—ãŸè·é›¢ã‚’è¨˜éŒ²ã—ã¦ã€ãƒªãƒ¼ã‚°ã®ä¸­ã§é †ä½ã‚’ä¸Šã’ã¦ã„ãã¾ã™ã€‚",
      "welcome.cta": "ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ",

      "login.title": "Make It Happen ã«ãƒ­ã‚°ã‚¤ãƒ³",
      "login.description": "ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹ã“ã¨ã§ã€è‡ªåˆ†ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã ã‘ã‚’ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚",
      "login.name": "åå‰",
      "login.password": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰",
      "login.code": "Hitachi Vantara å‚åŠ ã‚³ãƒ¼ãƒ‰",
      "login.submit": "ãƒ­ã‚°ã‚¤ãƒ³ / ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ",
      "login.note": "å‚åŠ ã§ãã‚‹ã®ã¯ Hitachi Vantara ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã§ã€ã‚³ãƒ¼ãƒ‰ ãŒå¿…è¦ã§ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯è‡ªåˆ†ã®ç«¯æœ«ã ã‘ã§ãªãã€å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚é•·æœŸé–“ã¾ã£ãŸãåˆ©ç”¨ã•ã‚Œãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯æ•´ç†ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚",

      "league.amateurs": "ã‚¢ãƒžãƒãƒ¥ã‚¢",
      "league.intermediates": "ãƒŸãƒ‰ãƒ«",
      "league.pros": "ãƒ—ãƒ­",
      "league.legends": "ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰",
      "league.pending": "ä¿ç•™",

      "leaderboard.title": "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
      "leaderboard.filter": "ãƒªãƒ¼ã‚°ã§çµžã‚Šè¾¼ã¿ï¼š",
      "leaderboard.all": "ã™ã¹ã¦ã®ãƒªãƒ¼ã‚°",
      "leaderboard.none": "ã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ã€‚",
      "lb.rank": "é †ä½",
      "lb.name": "åå‰",
      "lb.league": "ãƒªãƒ¼ã‚°",
      "lb.distance": "ç·è·é›¢ï¼ˆkmï¼‰",
      "lb.time": "ç·æ™‚é–“ï¼ˆåˆ†ï¼‰",

      "stats.title": "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆã¨ãƒªãƒ¼ã‚°æ˜‡é™æ ¼",
      "stats.runs": "å›žæ•°",
      "stats.totaldistance": "ç·è·é›¢ï¼ˆkmï¼‰",
      "stats.totaltime": "ç·æ™‚é–“ï¼ˆåˆ†ï¼‰",
      "stats.avgdistance": "å¹³å‡è·é›¢ï¼ˆkmï¼‰",
      "stats.bestdistance": "æœ€é•·è·é›¢ï¼ˆkmï¼‰",
      "stats.improvement": "æ”¹å–„åº¦",
      "stats.none": "å‚åŠ è€…ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²ã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
      "stats.promotions": "ä»Šæœˆã®æ˜‡æ ¼ / é™æ ¼ã‚’å®Ÿè¡Œ",
      "stats.placejoiners": "æ–°è¦å‚åŠ è€…ã‚’ãƒªãƒ¼ã‚°ã«å‰²ã‚Šå½“ã¦",

      "rules.title": "ãƒ«ãƒ¼ãƒ«ãƒ»ãƒªãƒ¼ã‚°ãƒ»è³žå“ã«ã¤ã„ã¦",
      "rules.joiningtitle": "å‚åŠ æ–¹æ³•ã¨ã‚¹ã‚¿ãƒ¼ãƒˆ",
      "rules.joiningtext":
        "å‚åŠ ã§ãã‚‹ã®ã¯ Hitachi Vantara ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ¼ãƒ‰ ãŒå¿…è¦ã§ã™ã€‚ã„ã¤ã§ã‚‚ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã§ãã¾ã™ã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€æœ€åˆã¯ã€Œä¿ç•™ã€çŠ¶æ…‹ã«ãªã‚Šã¾ã™ãŒã€ã™ãã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚ç¿Œæœˆã®åˆã‚ã«ã€æ‹…å½“è€…ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ä¿ç•™ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè·é›¢ãƒ»æ™‚é–“ãƒ»ã‚¹ãƒ”ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦å„ãƒªãƒ¼ã‚°ã«è‡ªå‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚",
      "rules.leaguetitle": "ãƒªãƒ¼ã‚°ã¨ãƒãƒ©ãƒ³ã‚¹",
      "rules.leaguetext":
        "ãƒªãƒ¼ã‚°ã¯4ã¤ã‚ã‚Šã¾ã™ï¼šã‚¢ãƒžãƒãƒ¥ã‚¢ã€ãƒŸãƒ‰ãƒ«ã€ãƒ—ãƒ­ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã€‚ã‚·ã‚¹ãƒ†ãƒ ã¯ãƒªãƒ¼ã‚°ã”ã¨ã®äººæ•°ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã‚ˆã†ã«ã—ã¾ã™ã€‚æ–°è¦å‚åŠ è€…ã‚’é…ç½®ã™ã‚‹ã¨ãã€ä¸€éƒ¨ã®ãƒªãƒ¼ã‚°ã ã‘æ¥µç«¯ã«äººæ•°ãŒå¤šããªã‚‰ãªã„ã‚ˆã†èª¿æ•´ã—ã¾ã™ã€‚",
      "rules.promotiontitle": "æ˜‡æ ¼ã¨é™æ ¼",
      "rules.promotiontext":
        "æ¯Žæœˆã€çµ±è¨ˆãƒšãƒ¼ã‚¸ã‹ã‚‰æ˜‡æ ¼ã¨é™æ ¼ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚ç§»å‹•äººæ•°ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ï¼š8äººä»¥ä¸Šã§1äººæ˜‡æ ¼ï¼‹1äººé™æ ¼ã€16äººä»¥ä¸Šã§2äººã€32äººä»¥ä¸Šã§3äººã§ã™ã€‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ç·è·é›¢ã‚’æœ€å„ªå…ˆã—ã€ãã®æ¬¡ã«ç·æ™‚é–“ã€æœ€å¾Œã«å¹³å‡ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦æ±ºã‚ã‚‰ã‚Œã¾ã™ã€‚",
      "rules.prizetitle": "è³žå“",
      "rules.prizetext":
        "å…·ä½“çš„ãªè³žå“å†…å®¹ã¯å„ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ ãŒæ±ºã‚ã‚‰ã‚Œã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹ã¨ã—ã¦ã¯ã€æ¯Žæœˆã®ãƒˆãƒƒãƒ—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å°ã•ãªè³žå“ã‚’ã€å¹´é–“ã§æœ€ã‚‚æ´»èºã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ˆã‚Šå¤§ããªè³žå“ã‚’ç”¨æ„ã™ã‚‹ã€ãªã©ãŒã‚ã‚Šã¾ã™ã€‚",

      "about.title": "Make It Happen ã¨ã¯",
      "about.text1":
        "Make It Happen ã¯ Hitachi Vantara ã®ãŸã‚ã®ã‚·ãƒ³ãƒ—ãƒ«ã§å…¬å¹³ãªãƒ˜ãƒ«ã‚¹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã™ã€‚ç›®çš„ã¯ã‚¨ãƒªãƒ¼ãƒˆã‚¢ã‚¹ãƒªãƒ¼ãƒˆã‚’ã¤ãã‚‹ã“ã¨ã§ã¯ãªãã€èª°ã‚‚ãŒã‚‚ã£ã¨å‹•ãã€è‡ªåˆ†ã®å¤‰åŒ–ã‚’ã‚ã‹ã‚Šã‚„ã™ãå®Ÿæ„Ÿã§ãã‚‹å ´ã‚’ã¤ãã‚‹ã“ã¨ã§ã™ã€‚",
      "about.text2":
        "æ­©ããƒ»èµ°ã‚‹ãƒ»è‡ªè»¢è»Šãªã©ã€å¥½ããªç§»å‹•æ–¹æ³•ã§è·é›¢ã¨æ™‚é–“ã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œã©ã‚Œãã‚‰ã„é€Ÿã„ã‹ã€ã ã‘ã§ãªãã€ã€Œã©ã‚Œã ã‘é•·ãå‹•ã„ãŸã‹ã€ã‚‚è©•ä¾¡ã—ã¾ã™ã€‚ã¤ã¾ã‚Šã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚ˆã‚Šã‚‚ç¶™ç¶šã—ã¦é ‘å¼µã‚‹äººã‚‚ã—ã£ã‹ã‚Šè©•ä¾¡ã•ã‚Œã¾ã™ã€‚",
      "about.text3":
        "æ–°ã—ã„å‚åŠ è€…ã¯ã¾ãšã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã—ã€ç¿Œæœˆã®ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«æ­£å¼ã«ã©ã“ã‹ã®ãƒªãƒ¼ã‚°ã¸å…¥ã‚Šã¾ã™ã€‚ã‚µã‚¤ãƒˆã¯ãã®æœ€åˆã®1ã‚«æœˆã‚’ä»–ã®å‚åŠ è€…ã¨æ¯”è¼ƒã—ã€ãã®äººã«åˆã£ãŸãƒªãƒ¼ã‚°ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚åŒæ™‚ã«ã€ãƒªãƒ¼ã‚°ã”ã¨ã®äººæ•°ãƒãƒ©ãƒ³ã‚¹ã‚‚ä¿ã¤ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚",

      "entry.title": "æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¨˜éŒ²",
      "entry.distance": "è·é›¢ï¼ˆkmï¼‰",
      "entry.time": "æ™‚é–“ï¼ˆåˆ†ï¼‰",
      "entry.submit": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä¿å­˜",
      "entry.my": "è‡ªåˆ†ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£",
      "entry.date": "æ—¥ä»˜",
      "entry.actions": "æ“ä½œ",
      "entry.none": "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã¯ã€ã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",

      "profile.runs": "å›žæ•°",
      "profile.totaldistance": "ç·è·é›¢",
      "profile.totaltime": "ç·æ™‚é–“",
      "profile.avgdistance": "å¹³å‡è·é›¢",
      "profile.avgpace": "å¹³å‡ãƒšãƒ¼ã‚¹",
      "profile.longest": "æœ€é•·ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£",
      "profile.best100m": "æœ€é€Ÿ ç´„100 m",
      "profile.best5k": "æœ€é€Ÿ ç´„5 km",

      "user.notLoggedIn": "æœªãƒ­ã‚°ã‚¤ãƒ³",
      "user.loginButton": "ãƒ­ã‚°ã‚¤ãƒ³",
      "user.loggedInAs": "{name} ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­",
      "user.leagueLabel": "ãƒªãƒ¼ã‚°ï¼š{league}",
      "user.addActivity": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¿½åŠ ",
      "user.logout": "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
      "user.deleteAccount": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤",

      "alert.loginMissing": "åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      "alert.codeWrong": "Hitachi ã®å‚åŠ ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚",
      "alert.passwordWrong": "ã“ã®åå‰ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚",
      "alert.firebase": "Firebase ãŒã¾ã æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã« Firebase è¨­å®šã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚",
      "alert.mustLogin": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¿½åŠ ã™ã‚‹å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚",
      "alert.activityInvalid": "è·é›¢ã¨æ™‚é–“ã‚’æ­£ã—ãã€æ­£ã®æ•°ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      "alert.noPlayers": "ã¾ã ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚",
      "alert.notEnoughPlayers": "æ˜‡æ ¼ãƒ»é™æ ¼ã«ã¯æœ€ä½Ž 8 äººã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã§ã™ã€‚",
      "alert.promotionsDone": "æ˜‡æ ¼ã¨é™æ ¼ã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š{up} äººæ˜‡æ ¼ã€{down} äººé™æ ¼ã€‚",
      "alert.noActivitiesToPlace": "ã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒãªã„ãŸã‚ã€é…ç½®ã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
      "alert.noPending": "ãƒªãƒ¼ã‚°ã«é…ç½®ã§ãã‚‹ä¿ç•™ä¸­ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚æ–°è¦å‚åŠ è€…ã¯ç¿Œæœˆã®é–‹å§‹æ™‚ã«ãƒªãƒ¼ã‚°ã«å…¥ã‚Šã¾ã™ã€‚",
      "alert.placeSummary": "{placed} äººã®æ–°è¦å‚åŠ è€…ã‚’ãƒªãƒ¼ã‚°ã«é…ç½®ã—ã¾ã—ãŸã€‚{skipped}",
      "alert.placeSkipped": "{count} äººã¯ä¿ç•™ã®ã¾ã¾ã§ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ã¾ãŸã¯ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ã®ãŸã‚ï¼‰ã€‚",
      "alert.deleteActivityConfirm": "ã“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
      "alert.deleteAccountConfirm": "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ã™ã¹ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ç¶šã‘ã¾ã™ã‹ï¼Ÿ"
    }
  };

  function t(key, vars) {
    const dict = translations[currentLang] || translations.en;
    let str = dict[key] || translations.en[key] || key;
    if (vars) {
      Object.keys(vars).forEach(k => {
        str = str.replace(`{${k}}`, vars[k]);
      });
    }
    return str;
  }

  function applyTranslations() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    renderHeaderUser(); // update header text in new language
  }

  function initLanguage() {
    const select = document.getElementById("lang-select");
    const saved = localStorage.getItem(LS_LANG_KEY) || "en";
    currentLang = saved;
    if (select) {
      select.value = saved;
      select.addEventListener("change", () => {
        currentLang = select.value;
        localStorage.setItem(LS_LANG_KEY, currentLang);
        applyTranslations();
      });
    }
    applyTranslations();
  }

  // ==========================
  //  BASIC HELPERS
  // ==========================

  function currentMonthKey(ts) {
    const d = ts ? new Date(ts) : new Date();
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    return `${y}-${String(m).padStart(2, "0")}`;
  }

  function formatDate(ts) {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return "";
    return d.toLocaleDateString();
  }

  function formatMinutesPretty(minutes) {
    if (!isFinite(minutes) || minutes <= 0) return "0:00";
    const totalSeconds = Math.round(minutes * 60);
    const m = Math.floor(totalSeconds / 60);
    const s = totalSeconds % 60;
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  function formatSecondsPretty(seconds) {
    if (!isFinite(seconds) || seconds <= 0) return "â€“";
    return `${seconds.toFixed(1)} s`;
  }

  function leagueIndex(league) {
    return LEAGUES.indexOf(league);
  }

  function formatImprovement(value) {
    if (!isFinite(value) || value === 0) return "0%";
    const rounded = Math.round(value);
    return (rounded > 0 ? "+" : "") + rounded + "%";
  }

  function getLeagueCounts() {
    const counts = { amateurs: 0, intermediates: 0, pros: 0, legends: 0 };
    users.forEach(u => {
      if (counts[u.league] !== undefined) counts[u.league]++;
    });
    return counts;
  }

  function canMoveLeague(user, targetLeague) {
    if (!LEAGUES.includes(targetLeague)) return false;
    const counts = getLeagueCounts();
    const from = LEAGUES.includes(user.league) ? user.league : null;

    if (from && counts[from] !== undefined) {
      counts[from] = Math.max(0, counts[from] - 1);
    }
    counts[targetLeague] = (counts[targetLeague] || 0) + 1;

    const values = Object.values(counts);
    const max = Math.max(...values);
    const min = Math.min(...values);
    return max - min <= 2;
  }

  // ==========================
  //  NAVIGATION
  // ==========================

  function showScene(name) {
    const scenes = document.querySelectorAll(".scene");
    scenes.forEach(scene => {
      scene.classList.remove("active");
      scene.style.display = "none";
    });

    const el =
      document.getElementById("scene-" + name) ||
      document.getElementById(name);

    if (el) {
      el.classList.add("active");
      el.style.display = "block";
    }

    const navButtons = document.querySelectorAll("header nav button");
    navButtons.forEach(btn => btn.classList.remove("active"));
    navButtons.forEach(btn => {
      const onclick = btn.getAttribute("onclick") || "";
      if (onclick.includes("'" + name + "'")) {
        btn.classList.add("active");
      }
    });
  }

  // ==========================
  //  FIREBASE INIT
  // ==========================

  function initFirebase() {
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (e) {
      console.error("Firebase init error:", e);
      alert(t("alert.firebase"));
    }
  }

  // ==========================
  //  DATA LOADING
  // ==========================

  async function loadAllData() {
    if (!db) return;
    const [usersSnap, actsSnap] = await Promise.all([
      db.collection("users").get(),
      db.collection("activities").get()
    ]);

    users = usersSnap.docs.map(doc => {
      const data = doc.data();
      if (!data.league) data.league = "pending";
      if (!data.joinMonth) data.joinMonth = currentMonthKey(data.createdAt || Date.now());
      return { id: doc.id, ...data };
    });

    entries = actsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    renderLeaderboard();
    renderStats();
    renderMyActivities();
  }

  function restoreCurrentUser() {
    const storedId = localStorage.getItem(LS_CURRENT_USER_KEY);
    if (!storedId) {
      currentUser = null;
      renderHeaderUser();
      updateEntryFormLockState();
      return;
    }
    const found = users.find(u => u.id === storedId);
    if (found) {
      currentUser = found;
    } else {
      localStorage.removeItem(LS_CURRENT_USER_KEY);
      currentUser = null;
    }
    renderHeaderUser();
    updateEntryFormLockState();
  }

  // ==========================
  //  PLAYER STATS
  // ==========================

  function getPlayerStats() {
    const byUser = {};

    entries.forEach(e => {
      const user = users.find(u => u.id === e.userId);
      if (!user) return;
      const key = user.id;
      if (!byUser[key]) {
        byUser[key] = {
          userId: user.id,
          name: user.name,
          league: user.league || "pending",
          runs: 0,
          totalDistance: 0,
          totalTime: 0,
          bestDistance: 0,
          firstEntry: null
        };
      }
      const stats = byUser[key];

      if (!stats.firstEntry || e.timestamp < stats.firstEntry.timestamp) {
        stats.firstEntry = {
          distanceKm: e.distanceKm,
          timeMinutes: e.timeMinutes,
          timestamp: e.timestamp
        };
      }

      stats.runs++;
      stats.totalDistance += e.distanceKm;
      stats.totalTime += e.timeMinutes;
      if (e.distanceKm > stats.bestDistance) stats.bestDistance = e.distanceKm;
    });

    let players = Object.values(byUser);

    players.forEach(p => {
      p.avgDistance = p.runs > 0 ? p.totalDistance / p.runs : 0;
      p.speed = p.totalTime > 0 ? p.totalDistance / p.totalTime : 0; // km per minute
      let improvement = 0;
      if (
        p.firstEntry &&
        p.firstEntry.distanceKm > 0 &&
        p.firstEntry.timeMinutes > 0 &&
        p.totalDistance > 0 &&
        p.totalTime > 0
      ) {
        const baselinePace = p.firstEntry.timeMinutes / p.firstEntry.distanceKm; // min/km
        const avgPace = p.totalTime / p.totalDistance; // min/km
        if (baselinePace > 0) {
          improvement = ((baselinePace - avgPace) / baselinePace) * 100;
        }
      }
      p.improvement = improvement;
    });

    // sort by distance, then time, then speed
    players.sort((a, b) => {
      if (b.totalDistance !== a.totalDistance) {
        return b.totalDistance - a.totalDistance;
      }
      if (b.totalTime !== a.totalTime) {
        return b.totalTime - a.totalTime;
      }
      return b.speed - a.speed;
    });

    players = players.map((p, index) => ({ ...p, rank: index + 1 }));
    return players;
  }

  // ==========================
  //  MONTHLY: PLACE NEW JOINERS
  // ==========================

  async function placeNewJoiners() {
    if (!db) return;

    const players = getPlayerStats();
    if (!players.length) {
      alert(t("alert.noActivitiesToPlace"));
      return;
    }

    const nowKey = currentMonthKey();
    const rankMap = {};
    players.forEach(p => { rankMap[p.userId] = p; });

    const candidates = users.filter(u =>
      u.league === "pending" &&
      u.joinMonth &&
      u.joinMonth < nowKey
    );

    if (!candidates.length) {
      alert(t("alert.noPending"));
      return;
    }

    const batch = db.batch();
    let placed = 0;
    let skipped = 0;

    function preferredLeaguesForTarget(target) {
      if (target === "legends") return ["legends", "pros"];
      if (target === "pros") return ["pros", "intermediates", "legends"];
      if (target === "intermediates") return ["intermediates", "amateurs", "pros"];
      if (target === "amateurs") return ["amateurs", "intermediates"];
      return ["amateurs"];
    }

    candidates.forEach(user => {
      const stats = rankMap[user.id];
      if (!stats || stats.runs < MIN_RUNS_FOR_PLACEMENT) {
        skipped++;
        return;
      }

      const N = players.length;
      const q = stats.rank / N;
      let targetLeague = "amateurs";
      if (q <= 0.25) targetLeague = "legends";
      else if (q <= 0.5) targetLeague = "pros";
      else if (q <= 0.75) targetLeague = "intermediates";
      else targetLeague = "amateurs";

      const prefs = preferredLeaguesForTarget(targetLeague);
      let finalLeague = null;

      for (const lg of prefs) {
        if (canMoveLeague(user, lg)) {
          finalLeague = lg;
          break;
        }
      }

      if (!finalLeague) {
        skipped++;
        return;
      }

      user.league = finalLeague;
      const userRef = db.collection("users").doc(user.id);
      batch.update(userRef, { league: finalLeague });
      placed++;
    });

    if (!placed) {
      alert("No new joiners could be placed yet. They may need more activities or the leagues are already very balanced.");
      return;
    }

    await batch.commit();
    await loadAllData();
    restoreCurrentUser();

    let skippedText = "";
    if (skipped > 0) {
      skippedText = t("alert.placeSkipped", { count: skipped });
    }
    alert(t("alert.placeSummary", { placed, skipped: skippedText }));
  }

  // ==========================
  //  MONTHLY: PROMOTIONS
  // ==========================

  async function applyPromotions() {
    if (!db) return;

    const players = getPlayerStats();
    const total = players.length;
    if (total === 0) {
      alert(t("alert.noPlayers"));
      return;
    }

    let moves = 0;
    if (total >= 32) moves = 3;
    else if (total >= 16) moves = 2;
    else if (total >= 8) moves = 1;
    else moves = 0;

    if (moves === 0) {
      alert(t("alert.notEnoughPlayers"));
      return;
    }

    const batch = db.batch();

    // promotions
    let promoted = 0;
    for (let i = 0; i < players.length && promoted < moves; i++) {
      const p = players[i];
      if (!LEAGUES.includes(p.league)) continue;
      const idx = leagueIndex(p.league);
      if (idx < 0 || idx >= LEAGUES.length - 1) continue;
      const userRef = db.collection("users").doc(p.userId);
      batch.update(userRef, { league: LEAGUES[idx + 1] });
      promoted++;
    }

    // relegations
    let relegated = 0;
    for (let i = players.length - 1; i >= 0 && relegated < moves; i--) {
      const p = players[i];
      if (!LEAGUES.includes(p.league)) continue;
      const idx = leagueIndex(p.league);
      if (idx <= 0) continue;
      const userRef = db.collection("users").doc(p.userId);
      batch.update(userRef, { league: LEAGUES[idx - 1] });
      relegated++;
    }

    await batch.commit();
    await loadAllData();
    restoreCurrentUser();
    alert(t("alert.promotionsDone", { up: moves, down: moves }));
  }

  // ==========================
  //  PROFILE VIEW
  // ==========================

  function showProfile(userId) {
    const card = document.getElementById("profile-card");
    const title = document.getElementById("profile-title");
    const summary = document.getElementById("profile-summary");

    const runsCell = document.getElementById("profile-runs");
    const totalDistCell = document.getElementById("profile-total-distance");
    const totalTimeCell = document.getElementById("profile-total-time");
    const avgDistCell = document.getElementById("profile-avg-distance");
    const avgPaceCell = document.getElementById("profile-avg-pace");
    const longestCell = document.getElementById("profile-longest");
    const best100mCell = document.getElementById("profile-100m");
    const best5kCell = document.getElementById("profile-5k");

    const user = users.find(u => u.id === userId);
    if (!user) return;

    const myEntries = entries
      .filter(e => e.userId === userId)
      .slice()
      .sort((a, b) => a.timestamp - b.timestamp);

    if (!myEntries.length) {
      title.textContent = `Profile: ${user.name}`;
      summary.textContent = "No activities logged yet.";
      runsCell.textContent = "0";
      totalDistCell.textContent = "0 km";
      totalTimeCell.textContent = "0";
      avgDistCell.textContent = "â€“";
      avgPaceCell.textContent = "â€“";
      longestCell.textContent = "â€“";
      best100mCell.textContent = "â€“";
      best5kCell.textContent = "â€“";
      showScene("profile-card");
      return;
    }

    let runs = myEntries.length;
    let totalDistance = 0;
    let totalTime = 0;
    let longest = 0;
    let best100mSeconds = Infinity;
    let best5kMinutes = Infinity;

    myEntries.forEach(e => {
      totalDistance += e.distanceKm;
      totalTime += e.timeMinutes;
      if (e.distanceKm > longest) longest = e.distanceKm;

      if (e.distanceKm > 0 && e.timeMinutes > 0) {
        const paceMinutesPerKm = e.timeMinutes / e.distanceKm;
        const hundredSeconds = paceMinutesPerKm * 0.1 * 60;
        if (hundredSeconds < best100mSeconds) best100mSeconds = hundredSeconds;

        if (e.distanceKm >= 4.5) {
          const fiveKMinutes = paceMinutesPerKm * 5;
          if (fiveKMinutes < best5kMinutes) best5kMinutes = fiveKMinutes;
        }
      }
    });

    const avgDistance = totalDistance / runs;
    const avgPaceMinutesPerKm =
      totalDistance > 0 && totalTime > 0 ? totalTime / totalDistance : 0;

    function formatPace(minPerKm) {
      if (!isFinite(minPerKm) || minPerKm <= 0) return "â€“";
      const totalSeconds = Math.round(minPerKm * 60);
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${m}:${s.toString().padStart(2, "0")} min/km`;
    }

    title.textContent = `Profile: ${user.name}`;
    const leagueLabel = LEAGUES.includes(user.league)
      ? t("league." + user.league)
      : t("league.pending");

    summary.textContent = `${t("user.leagueLabel", { league: leagueLabel })}, ${t("stats.runs")}: ${runs}`;

    runsCell.textContent = runs.toString();
    totalDistCell.textContent = `${totalDistance.toFixed(2)} km`;
    totalTimeCell.textContent = formatMinutesPretty(totalTime);
    avgDistCell.textContent = `${avgDistance.toFixed(2)} km`;
    avgPaceCell.textContent = formatPace(avgPaceMinutesPerKm);
    longestCell.textContent = `${longest.toFixed(2)} km`;
    best100mCell.textContent = formatSecondsPretty(best100mSeconds);
    best5kCell.textContent =
      isFinite(best5kMinutes) && best5kMinutes > 0
        ? formatMinutesPretty(best5kMinutes)
        : "â€“";

    showScene("profile-card");
  }

  function attachProfileLinks() {
    document.querySelectorAll(".link-name").forEach(btn => {
      const userId = btn.getAttribute("data-user-id");
      btn.onclick = () => showProfile(userId);
    });
  }

  // ==========================
  //  RENDER FUNCTIONS
  // ==========================

  function renderHeaderUser() {
    const container = document.getElementById("user-controls");
    if (!container) return;
    container.innerHTML = "";

    if (!currentUser) {
      const span = document.createElement("span");
      span.textContent = t("user.notLoggedIn");
      container.appendChild(span);

      const btn = document.createElement("button");
      btn.className = "btn btn-small";
      btn.textContent = t("user.loginButton");
      btn.onclick = () => showScene("login");
      container.appendChild(btn);
      return;
    }

    const name = currentUser.name;
    const leagueKey = LEAGUES.includes(currentUser.league)
      ? "league." + currentUser.league
      : "league.pending";
    const leagueLabel = t(leagueKey);

    const info = document.createElement("span");
    info.textContent = `${t("user.loggedInAs", { name })} Â· ${t("user.leagueLabel", { league: leagueLabel })}`;
    container.appendChild(info);

    const addBtn = document.createElement("button");
    addBtn.className = "btn btn-small";
    addBtn.style.marginLeft = "8px";
    addBtn.textContent = t("user.addActivity");
    addBtn.onclick = () => showScene("entry");
    container.appendChild(addBtn);

    const logoutBtn = document.createElement("button");
    logoutBtn.className = "btn btn-small";
    logoutBtn.style.marginLeft = "4px";
    logoutBtn.textContent = t("user.logout");
    logoutBtn.onclick = logout;
    container.appendChild(logoutBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "btn btn-small danger";
    deleteBtn.style.marginLeft = "4px";
    deleteBtn.textContent = t("user.deleteAccount");
    deleteBtn.onclick = deleteAccount;
    container.appendChild(deleteBtn);
  }

  function renderLeaderboard() {
    const tbody = document.getElementById("leaderboard-body");
    const empty = document.getElementById("no-entries");
    if (!tbody) return;
    tbody.innerHTML = "";

    const players = getPlayerStats();
    const filterSel = document.getElementById("league-filter");
    const filter = filterSel ? filterSel.value : "all";

    let filtered = players;
    if (filter !== "all") {
      filtered = players.filter(p => p.league === filter);
    }

    if (!filtered.length) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    filtered.forEach(player => {
      const tr = document.createElement("tr");

      let rankSymbol = player.rank;
      if (player.rank === 1) rankSymbol = "ðŸ¥‡";
      else if (player.rank === 2) rankSymbol = "ðŸ¥ˆ";
      else if (player.rank === 3) rankSymbol = "ðŸ¥‰";

      const leagueClass = LEAGUES.includes(player.league)
        ? player.league
        : "pending";
      const leagueLabel = LEAGUES.includes(player.league)
        ? t("league." + player.league)
        : t("league.pending");

      tr.innerHTML = `
        <td>${rankSymbol}</td>
        <td>
          <button type="button" class="link-name" data-user-id="${player.userId}" style="background:none;border:none;color:#007bff;cursor:pointer;text-decoration:underline;">
            ${player.name}
          </button>
        </td>
        <td><span class="badge-league ${leagueClass}">${leagueLabel}</span></td>
        <td>${player.totalDistance.toFixed(2)}</td>
        <td>${player.totalTime.toFixed(1)}</td>
      `;
      tbody.appendChild(tr);
    });

    attachProfileLinks();
  }

  function renderStats() {
    const tbody = document.getElementById("stats-body");
    const empty = document.getElementById("no-stats");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!entries.length) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    const players = getPlayerStats();

    players.forEach(stats => {
      const leagueClass = LEAGUES.includes(stats.league)
        ? stats.league
        : "pending";
      const leagueLabel = LEAGUES.includes(stats.league)
        ? t("league." + stats.league)
        : t("league.pending");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <button type="button" class="link-name" data-user-id="${stats.userId}" style="background:none;border:none;color:#007bff;cursor:pointer;text-decoration:underline;">
            ${stats.name}
          </button>
        </td>
        <td><span class="badge-league ${leagueClass}">${leagueLabel}</span></td>
        <td>${stats.runs}</td>
        <td>${stats.totalDistance.toFixed(2)}</td>
        <td>${stats.totalTime.toFixed(1)}</td>
        <td>${stats.avgDistance.toFixed(2)}</td>
        <td>${stats.bestDistance.toFixed(2)}</td>
        <td>${formatImprovement(stats.improvement)}</td>
      `;
      tbody.appendChild(tr);
    });

    attachProfileLinks();
  }

  function renderMyActivities() {
    const tbody = document.getElementById("my-activities-body");
    const empty = document.getElementById("no-my-activities");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!currentUser) {
      if (empty) {
        empty.style.display = "block";
        empty.textContent = t("user.notLoggedIn");
      }
      return;
    }

    const myEntries = entries.filter(e => e.userId === currentUser.id);

    if (!myEntries.length) {
      if (empty) {
        empty.style.display = "block";
        empty.textContent = t("entry.none");
      }
      return;
    }
    if (empty) empty.style.display = "none";

    myEntries
      .slice()
      .sort((a, b) => b.timestamp - a.timestamp)
      .forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDate(e.timestamp)}</td>
          <td>${e.distanceKm.toFixed(2)}</td>
          <td>${e.timeMinutes.toFixed(1)}</td>
          <td>
            <button class="btn btn-small danger" style="padding:4px 8px;font-size:12px;" onclick="deleteActivity('${e.id}')">
              âœ•
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  }

  function updateEntryFormLockState() {
    const distanceInput = document.getElementById("distance");
    const timeInput = document.getElementById("time");
    const form = document.getElementById("entry-form");
    if (!form) return;
    const submit = form.querySelector("button[type='submit']");
    const locked = !currentUser;

    if (distanceInput) distanceInput.disabled = locked;
    if (timeInput) timeInput.disabled = locked;
    if (submit) submit.disabled = locked;
  }

  // ==========================
  //  ACTIVITY DELETION
  // ==========================

  async function deleteActivity(id) {
    if (!currentUser) {
      alert(t("alert.mustLogin"));
      return;
    }
    const entry = entries.find(e => e.id === id);
    if (!entry) return;
    if (entry.userId !== currentUser.id) {
      alert("You can only delete your own activities.");
      return;
    }
    if (!confirm(t("alert.deleteActivityConfirm"))) return;

    await db.collection("activities").doc(id).delete();
    await loadAllData();
    restoreCurrentUser();
  }

  // ==========================
  //  AUTH
  // ==========================

  async function login(name, password, codeInput) {
    if (!db) {
      alert(t("alert.firebase"));
      return;
    }
    const trimmedName = (name || "").trim();
    if (!trimmedName || !password) {
      alert(t("alert.loginMissing"));
      return;
    }

    // join code
    let codeOk = localStorage.getItem(LS_CODE_OK_KEY) === "true";
    const typedCode = (codeInput || "").trim().toUpperCase();
    if (!codeOk) {
      if (typedCode !== HITACHI_CODE) {
        alert(t("alert.codeWrong"));
        return;
      }
      localStorage.setItem(LS_CODE_OK_KEY, "true");
      codeOk = true;
    }

    // find or create user
    const existingSnap = await db
      .collection("users")
      .where("name", "==", trimmedName)
      .limit(1)
      .get();

    let userDoc = null;
    if (existingSnap.empty) {
      const joinMonth = currentMonthKey();
      const newUser = {
        name: trimmedName,
        password,
        league: "pending",
        createdAt: Date.now(),
        joinMonth
      };
      const docRef = await db.collection("users").add(newUser);
      userDoc = { id: docRef.id, ...newUser };
    } else {
      const doc = existingSnap.docs[0];
      const data = doc.data();
      if (data.password !== password) {
        alert(t("alert.passwordWrong"));
        return;
      }
      if (!data.league) data.league = "pending";
      if (!data.joinMonth) data.joinMonth = currentMonthKey(data.createdAt || Date.now());
      userDoc = { id: doc.id, ...data };
    }

    currentUser = userDoc;
    localStorage.setItem(LS_CURRENT_USER_KEY, currentUser.id);

    await loadAllData();
    restoreCurrentUser();
    updateEntryFormLockState();
    showScene("entry");
  }

  async function logout() {
    currentUser = null;
    localStorage.removeItem(LS_CURRENT_USER_KEY);
    renderHeaderUser();
    updateEntryFormLockState();
    renderMyActivities();
    showScene("welcome");
  }

  async function deleteAccount() {
    if (!currentUser) return;
    if (!confirm(t("alert.deleteAccountConfirm"))) return;

    const userId = currentUser.id;

    const actsSnap = await db
      .collection("activities")
      .where("userId", "==", userId)
      .get();
    const batch = db.batch();
    actsSnap.forEach(doc => batch.delete(doc.ref));
    batch.delete(db.collection("users").doc(userId));
    await batch.commit();

    currentUser = null;
    localStorage.removeItem(LS_CURRENT_USER_KEY);
    await loadAllData();
    renderHeaderUser();
    updateEntryFormLockState();
    renderMyActivities();
    showScene("welcome");
  }

  // ==========================
  //  FORMS
  // ==========================

  function setupForms() {
    const loginForm = document.getElementById("login-form");
    if (loginForm) {
      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const name = document.getElementById("login-name").value;
        const password = document.getElementById("login-password").value;
        const code = document.getElementById("login-code").value;
        login(name, password, code);
      });
    }

    const codeInput = document.getElementById("login-code");
    if (codeInput) {
      codeInput.addEventListener("input", () => {
        codeInput.value = codeInput.value.toUpperCase();
      });
    }

    const entryForm = document.getElementById("entry-form");
    if (entryForm) {
      entryForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser) {
          alert(t("alert.mustLogin"));
          showScene("login");
          return;
        }

        const distance = parseFloat(document.getElementById("distance").value);
        const time = parseFloat(document.getElementById("time").value);

        if (isNaN(distance) || isNaN(time) || distance <= 0 || time <= 0) {
          alert(t("alert.activityInvalid"));
          return;
        }

        await db.collection("activities").add({
          userId: currentUser.id,
          distanceKm: distance,
          timeMinutes: time,
          timestamp: Date.now()
        });

        await loadAllData();
        restoreCurrentUser();
        entryForm.reset();
        showScene("leaderboard");
      });
    }

    const leagueFilter = document.getElementById("league-filter");
    if (leagueFilter) {
      leagueFilter.addEventListener("change", renderLeaderboard);
    }
  }

  // ==========================
  //  INIT
  // ==========================

  async function init() {
    initLanguage();
    initFirebase();
    setupForms();

    if (!db) return;

    await loadAllData();
    restoreCurrentUser();
    updateEntryFormLockState();

    if (currentUser) {
      showScene("leaderboard");
    } else {
      showScene("welcome");
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
